import{r as i,j as e,C as p,I as ce,d as re,e as x,s as oe,X as C,Y as de,Z as me,$ as Z,T as ue,f as he,b as ge,B as fe,a0 as xe,a1 as Y,a2 as pe}from"./index-CeRyFU8i.js";import{c as je}from"./calcDistance-p9X9NEyQ.js";import{C as k,B as g,L as z,S as ve,b as we}from"./Section-QMicwmgN.js";import{I as be,a as G,L as Ne,Z as ye}from"./index-BCbb4Onk.js";import{I as Ce,F as ke,G as Te,M as Ie}from"./MapContainerYandex-DKiyZW08.js";import{I as Se,F as De}from"./FileInput-BT9eBxdP.js";import{I as y}from"./Input-Bl3NiK-W.js";import{A as Fe}from"./Avatar-BEihHwMn.js";import"./VisuallyHidden-B7MVzgWd.js";function Ae({title:c,titleId:r,...o},d){return i.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:d,"aria-labelledby":r},o),c?i.createElement("title",{id:r},c):null,i.createElement("path",{d:"M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32L19.513 8.2Z"}))}const Ee=i.forwardRef(Ae),f=({type:c,title:r,children:o,editMode:d=!1})=>{const[m,h]=i.useState(!1);return e.jsxs("div",{children:[e.jsx(p,{level:"2",weight:"2",className:"pl-6 text-[--tg-theme-hint-color]",children:r}),d?o:e.jsx(k,{multiline:m,onClick:()=>{c==="text"&&h(n=>!n)},children:o})]})},Ye=({task:c})=>{const r=x(he),o=ge(),d=x(n=>C(n,c.id)),[m,h]=i.useState();return i.useEffect(()=>{var n;h(je((n=c.location)==null?void 0:n.latLong,r.latLong))},[r,c]),e.jsx(e.Fragment,{children:e.jsx(k,{before:e.jsx(Fe,{children:"CS"}),id:c.id,className:"w-full select-none",multiline:!1,description:c.desc,after:e.jsx("span",{children:c.reward.cost+" "+c.reward.currency}),titleBadge:d?e.jsx(fe,{className:"bg-yellow-600",mode:"critical",type:"number",children:"!"}):e.jsx(e.Fragment,{}),subhead:m+" km",onClick:()=>o("/tasks/task/"+c.id),children:c.title})})},ze=()=>{var E,B,L,M,O,R,U,J;const c=ce(),r=re(),o=x(oe),d=c.taskId||"-1",[m,h]=i.useState(x(s=>C(s,d))||!1),[n,j]=i.useState(x(s=>C(s,d))||!1),a=x(s=>de(s,d)),$=JSON.parse(sessionStorage.getItem("edited-task-"+d)||"{}"),[t,u]=i.useState(m?$:a),v=i.useMemo(()=>(a==null?void 0:a.customer.id)===o.id,[a,o]),[T,H]=i.useState(!1);i.useEffect(()=>{r(m?me(d):Z(d))},[m,d,r]),i.useEffect(()=>{t&&(JSON.stringify(a)!==JSON.stringify(t)?(sessionStorage.setItem("edited-task-"+t.id,JSON.stringify(t)),h(!0)):(h(!1),sessionStorage.removeItem("edited-task-"+t.id)))},[t,a]),i.useEffect(()=>{m||(console.log("Sync task"),u(a))},[a,m]);const[X,I]=i.useState(!1),q=s=>{s.preventDefault(),console.log("Edit mode handler"),j(!0),m&&I(!0),n&&!m&&j(!1)},K=s=>{if(t){s.preventDefault();const l=s.currentTarget.files;if(console.log(l),l&&(l==null?void 0:l.length)>0){const P=[];for(let N=0;N<l.length;N++)P.push(URL.createObjectURL(l[N]));const ie=t.attachments||[];u({...t,attachments:[...ie,...P]})}}},Q=s=>{if(t){const l=[...t.attachments||[]];console.log(l),l.splice(s,1),console.log(l),u({...t,attachments:l})}},[V,S]=i.useState(!1),[W,D]=i.useState(0),_=s=>{console.log("Open image fullscreen. Index: "+s),S(!0),D(s)},ee=()=>{console.log("Close image fullscreen"),S(!1),D(0)},te=async s=>{s.preventDefault(),w(!0),setTimeout(()=>{console.log("Do something after 2 secs"),r(xe(d)),w(!1),history.back()},2e3)},[b,w]=i.useState(!1),[F,A]=i.useState(!1),se=async s=>{a&&(s.preventDefault(),console.log("Clicked accept"),w(!0),setTimeout(()=>{console.log("Do something after 2 secs"),r(Y({id:a.id,status:"active",user:{id:o.id,name:(o.firstName+" "+o.lastName||"").trim()}})),w(!1),history.back()},2e3))},ae=async s=>{a&&(s.preventDefault(),console.log("Clicked dismiss"),A(!0),await setTimeout(()=>{console.log("Do something after 5 secs"),r(Y({id:a.id,status:"open",user:{id:o.id,name:(o.firstName+" "+o.lastName||"").trim()}})),A(!1),history.back()},2e3))},le=()=>{const s=document.getElementsByTagName("input");for(let l=0;l<s.length;l++)s[l].blur();if(t){if(t.title.trim().length===0||t.desc.trim().length===0||t.reward.cost===0||!t.location.available)return H(!0);console.log("Save edited task to Redux"),r(pe(t)),r(Z(t.id)),h(!1),j(!1)}},ne=()=>{console.log("Changes canceled"),u(a),j(!1),h(!1)};return!a||!t?e.jsx(e.Fragment,{children:"Task not found"}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col gap-1 h-full",children:[m&&e.jsx("div",{className:"bg-yellow-400 text-center rounded-lg mb-1",children:"You have uncommited changes!!!"}),e.jsxs("div",{className:"p-2 flex align-middle items-center justify-between w-full",children:[e.jsx(ue,{children:"Task details"}),e.jsx(g,{mode:"plain",onClick:()=>history.back(),children:"Back"})]}),e.jsx(z,{children:e.jsx(ve,{header:e.jsxs("div",{className:"flex justify-between align-middle p-2",children:[e.jsxs(we,{children:["Task N",d]}),v&&e.jsx(Ce,{className:"w-8 h-8 self-end".concat(" ",X?"animate-jiggle text-red-400":""),onClick:q,onAnimationEnd:()=>{I(!1)},children:e.jsx(Ee,{})})]}),children:e.jsxs(z,{className:"flex flex-col gap-2 h-full",children:[e.jsx(f,{title:"Title",editMode:n,type:"text",children:e.jsxs(e.Fragment,{children:[n?e.jsx(y,{value:t.title,status:t.title.length===0?"error":void 0,placeholder:"Title...",onChange:s=>{const l=s.currentTarget.value;u({...t,title:l})}}):t.title,e.jsx(p,{className:"pl-8 text-red-400",hidden:t.title.length!==0,children:"This field cant be empty"})]})}),e.jsx(f,{title:"Description",editMode:n,type:"text",children:e.jsxs(e.Fragment,{children:[n?e.jsx(y,{placeholder:"Description...",value:t.desc,status:t.desc.length===0?"error":void 0,onChange:s=>u({...t,desc:s.currentTarget.value})}):t.desc,e.jsx(p,{className:"pl-8 text-red-400",hidden:t.desc.length!==0,children:"This field cant be empty"})]})}),e.jsx(f,{title:"Reward",editMode:n,type:"text",children:e.jsx(e.Fragment,{children:n?e.jsxs("div",{className:"flex items-center justify-stretch h-fit",children:[e.jsxs("div",{className:"w-2/5 h-full flex flex-col justify-between",children:[e.jsx(y,{placeholder:"Cost...",inputMode:"numeric",type:"number",status:t.reward.cost===0?"error":void 0,value:t.reward.cost||"",onChange:s=>{u({...t,reward:{...t.reward,cost:Number(s.currentTarget.value)}})}}),e.jsx(p,{className:"pl-8 text-red-400",hidden:!(t.reward.cost===0&&T),children:"This field cant be empty"})]}),e.jsx("div",{className:"w-3/5 flex flex-col h-full justify-between",children:e.jsxs(be,{className:"h-12 items-center",children:[e.jsx(G,{onClick:()=>u({...t,reward:{...t.reward,currency:"TON"}}),mode:t.reward.currency==="TON"?"bezeled":"plain",children:"TON"}),e.jsx(G,{onClick:()=>u({...t,reward:{...t.reward,currency:"USDT"}}),mode:t.reward.currency==="USDT"?"bezeled":"plain",children:"USDT"})]})})]}):t.reward.cost+" "+t.reward.currency})}),t.attachments&&t.attachments.length>0&&e.jsx(f,{title:"Attachments",type:"other",children:e.jsx("div",{className:"pl-6 pr-6 p-2 grid grid-flow-row grid-cols-3 gap-2",children:t.attachments.map((s,l)=>e.jsxs("div",{className:"relative",children:[e.jsx(Se,{size:96,src:s,onClick:()=>_(l)}),n&&e.jsx(ke,{className:"absolute right-0 -top-2 w-6 h-6 border border-gray-500 rounded-full bg-gray-400 bg-opacity-55",onClick:()=>Q(l)})]},l+s))})}),n&&e.jsx(De,{multiple:!0,label:"Attach a new file",accept:"image/*",onChange:K}),e.jsx(f,{title:"Customer",type:"text",children:(E=t.customer)==null?void 0:E.name}),e.jsx("div",{children:e.jsx(f,{title:"Address",editMode:n,type:"other",children:e.jsxs(e.Fragment,{children:[n?e.jsxs(e.Fragment,{children:[e.jsx(k,{multiline:!0,children:(L=(B=t.location)==null?void 0:B.address)==null?void 0:L.formattedAdress}),e.jsx(Te,{status:!t.location.available&&T?"error":void 0,geoposition:t.location||{available:!1},setGeoposition:s=>u({...t,location:s})})]}):(O=(M=t.location)==null?void 0:M.address)==null?void 0:O.formattedAdress,e.jsx(p,{className:"pl-8 text-red-400",hidden:t.location.available,children:"Please enter correct address"})]})})}),e.jsx("div",{className:"pb-8",children:e.jsx(f,{title:"On map",type:"other",children:e.jsx(Ie,{available:t.location.available,type:"target",center:{latitude:Number((R=t.location.latLong)==null?void 0:R.latitude),longitude:Number((U=t.location.latLong)==null?void 0:U.longitude)}})})})]})})}),e.jsxs("div",{className:"sticky bottom-24 pl-4 pr-4",children:[!v&&e.jsxs("div",{className:"flex flex-row justify-center items-center",children:[a.status==="open"&&e.jsx(g,{className:"bg-green-600 w-2/6",onClick:se,loading:b,children:"Accept"}),a.status==="active"&&e.jsx(g,{className:"bg-red-600 w-2/6",onClick:ae,loading:F,children:"Decline"})]}),v&&!n&&e.jsxs("div",{className:"flex flex-row justify-center items-center",children:[a.status==="open"&&e.jsx(g,{className:"bg-red-600 w-1/2",onClick:te,loading:b,children:"Delete task"}),a.status==="active"&&e.jsx(g,{className:"bg-red-600 w-1/2",disabled:!0,children:"You cant delete active task"})]}),v&&n&&e.jsxs("div",{className:"flex flex-row justify-center items-center",children:[e.jsx(g,{className:"bg-green-600 w-2/6",onClick:le,loading:b,children:"Confirm"}),e.jsx(g,{className:"bg-red-600 w-2/6",onClick:ne,loading:F,children:"Cancel"})]})]})]}),e.jsx(Ne,{open:V,controller:{closeOnPullDown:!0,closeOnBackdropClick:!0,closeOnPullUp:!0},close:ee,index:W,plugins:[ye],slides:(J=a==null?void 0:a.attachments)==null?void 0:J.map(s=>({src:s}))})]})};export{ze as TaskCard,Ye as TaskMiniCard};
