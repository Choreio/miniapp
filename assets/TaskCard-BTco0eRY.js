import{r as l,U as fe,j as e,C as b,B as he,b as ge,c as w,s as xe,V as I,W as pe,X as je,Y as H,T as we,I as ve,d as be,u as Ne,$ as W,Z as Ce,a0 as X,a1 as ke}from"./index-DiiwTkhM.js";import{c as ye}from"./calcDistance-UWrR0_E3.js";import{C as T,B as x,L as q,S as Ie,c as Te}from"./Section-DYTWTpqy.js";import{I as Se,a as K,L as Ee,Z as De}from"./index-U5d-jmn0.js";import{I as Fe,G as Ae,M as Be}from"./MapContainerYandex-CpeBzLA5.js";import{I as Oe,F as Le,B as Me}from"./FileInput-DQoSSVou.js";import{I as y}from"./Input-BpU-p-6y.js";import{A as Re}from"./Avatar-hU1ca7qu.js";import"./VisuallyHidden-BaFZ998l.js";function Ue({title:i,titleId:r,...o},d){return l.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:d,"aria-labelledby":r},o),i?l.createElement("title",{id:r},i):null,l.createElement("path",{d:"M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32L19.513 8.2Z"}))}const Ve=l.forwardRef(Ue),Je={some:0,all:1};function Pe(i,r,{root:o,margin:d,amount:u="some"}={}){const f=fe(i),n=new WeakMap,h=v=>{v.forEach(t=>{const m=n.get(t.target);if(t.isIntersecting!==!!m)if(t.isIntersecting){const g=r(t);typeof g=="function"?n.set(t.target,g):a.unobserve(t.target)}else m&&(m(t),n.delete(t.target))})},a=new IntersectionObserver(h,{root:o,rootMargin:d,threshold:typeof u=="number"?u:Je[u]});return f.forEach(v=>a.observe(v)),()=>a.disconnect()}function Ze(i,{root:r,margin:o,amount:d,once:u=!1}={}){const[f,n]=l.useState(!1);return l.useEffect(()=>{if(!i.current||u&&f)return;const h=()=>(n(!0),u?void 0:()=>n(!1)),a={root:r&&r.current||void 0,margin:o,amount:d};return Pe(i.current,h,a)},[r,i,o,u,d]),f}const p=({type:i,title:r,children:o,editMode:d=!1})=>{const[u,f]=l.useState(!1);return e.jsxs("div",{children:[e.jsx(b,{level:"2",weight:"2",className:"pl-6 text-[--tg-theme-hint-color]",children:r}),d?o:e.jsx(T,{multiline:u,onClick:()=>{i==="text"&&f(n=>!n)},children:o})]})},Qe=({task:i})=>{const r=w(be),o=Ne(),d=w(a=>I(a,i.id)),[u,f]=l.useState();l.useEffect(()=>{var a;f(ye((a=i.location)==null?void 0:a.latLong,r.latLong))},[r,i]);const n=l.useRef(null),h=Ze(n,{once:!0});return e.jsx(T,{before:e.jsx(Re,{children:"CS"}),id:i.id,ref:n,style:{transform:h?"none":"translateX(-100px)",opacity:h?1:0,transition:"all 0.6s cubic-bezier(0.17, 0.55, 0.55, 1) 0.5s"},className:"w-full",multiline:!1,description:i.desc,after:e.jsx("span",{children:i.reward.cost+" "+i.reward.currency}),titleBadge:d?e.jsx(Me,{className:"bg-yellow-600",mode:"critical",type:"number",children:"!"}):e.jsx(e.Fragment,{}),subhead:u+" km",onClick:()=>o("/tasks/task/"+i.id),children:i.title})},_e=()=>{var O,L,M,R,U,V,J,P,Z,z,Y,$,G;const i=he(),r=ge(),o=w(xe),d=i.taskId||"-1",[u,f]=l.useState(w(s=>I(s,d))||!1),[n,h]=l.useState(w(s=>I(s,d))||!1),a=w(s=>pe(s,d)),v=JSON.parse(sessionStorage.getItem("edited-task-"+d)||"{}"),[t,m]=l.useState(u?v:a),g=l.useMemo(()=>(a==null?void 0:a.customer.id)===o.id,[a,o]),[S,Q]=l.useState(!1);l.useEffect(()=>{r(u?je(d):H(d))},[u,d,r]),l.useEffect(()=>{t&&(JSON.stringify(a)!==JSON.stringify(t)?(sessionStorage.setItem("edited-task-"+t.id,JSON.stringify(t)),f(!0)):(f(!1),sessionStorage.removeItem("edited-task-"+t.id)))},[t,a]),l.useEffect(()=>{u||(console.log("Sync task"),m(a))},[a,u]);const[_,E]=l.useState(!1),ee=s=>{s.preventDefault(),console.log("Edit mode handler"),h(!0),u&&(W.isSupported()&&W.notificationOccurred("warning"),E(!0)),n&&!u&&h(!1)},te=s=>{if(t){s.preventDefault();const c=s.currentTarget.files;if(console.log(c),c&&(c==null?void 0:c.length)>0){const j=[];for(let k=0;k<c.length;k++)j.push(URL.createObjectURL(c[k]));const me=t.attachments||[];m({...t,attachments:[...me,...j]})}}},se=s=>{if(t){const c=[...t.attachments||[]];console.log(c),c.splice(s,1),console.log(c),m({...t,attachments:c})}},[ae,D]=l.useState(!1),[ne,F]=l.useState(0),le=s=>{console.log("Open image fullscreen. Index: "+s),D(!0),F(s)},ie=()=>{console.log("Close image fullscreen"),D(!1),F(0)},re=async s=>{s.preventDefault(),N(!0),setTimeout(()=>{console.log("Do something after 2 secs"),r(Ce(d)),N(!1),history.back()},2e3)},[C,N]=l.useState(!1),[A,B]=l.useState(!1),ce=async s=>{a&&(s.preventDefault(),console.log("Clicked accept"),N(!0),setTimeout(()=>{console.log("Do something after 2 secs"),r(X({id:a.id,status:"active",user:{id:o.id,name:(o.firstName+" "+o.lastName||"").trim()}})),N(!1),history.back()},2e3))},oe=async s=>{a&&(s.preventDefault(),console.log("Clicked dismiss"),B(!0),await setTimeout(()=>{console.log("Do something after 5 secs"),r(X({id:a.id,status:"open",user:{id:o.id,name:(o.firstName+" "+o.lastName||"").trim()}})),B(!1),history.back()},2e3))},de=()=>{var c;const s=document.getElementsByTagName("input");for(let j=0;j<s.length;j++)s[j].blur();if(t){if(t.title.trim().length===0||t.desc.trim().length===0||t.reward.cost===0||!((c=t.location)!=null&&c.available))return Q(!0);console.log("Save edited task to Redux"),r(ke(t)),r(H(t.id)),f(!1),h(!1)}},ue=()=>{console.log("Changes canceled"),m(a),h(!1),f(!1)};return!a||!t?e.jsx(e.Fragment,{children:"Task not found"}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col gap-1 h-full",children:[u&&e.jsx("div",{className:"bg-yellow-400 text-center rounded-lg mb-1",children:"You have uncommited changes!!!"}),e.jsxs("div",{className:"p-2 flex align-middle items-center justify-between w-full",children:[e.jsx(we,{children:"Task details"}),e.jsx(x,{mode:"plain",onClick:()=>history.back(),children:"Back"})]}),e.jsx(q,{children:e.jsx(Ie,{header:e.jsxs("div",{className:"flex justify-between align-middle p-2",children:[e.jsxs(Te,{children:["Task N",d]}),g&&e.jsx(Fe,{className:"w-8 h-8 self-end".concat(" ",_?"animate-jiggle text-red-400":""),onClick:ee,onAnimationEnd:()=>{E(!1)},children:e.jsx(Ve,{})})]}),children:e.jsxs(q,{className:"flex flex-col gap-2 h-full",children:[e.jsx(p,{title:"Title",editMode:n,type:"text",children:e.jsxs(e.Fragment,{children:[n?e.jsx(y,{value:t.title,status:t.title.length===0?"error":void 0,placeholder:"Title...",onChange:s=>{const c=s.currentTarget.value;m({...t,title:c})}}):t.title,e.jsx(b,{className:"pl-8 text-red-400",hidden:t.title.length!==0,children:"This field cant be empty"})]})}),e.jsx(p,{title:"Description",editMode:n,type:"text",children:e.jsxs(e.Fragment,{children:[n?e.jsx(y,{placeholder:"Description...",value:t.desc,status:t.desc.length===0?"error":void 0,onChange:s=>m({...t,desc:s.currentTarget.value})}):t.desc,e.jsx(b,{className:"pl-8 text-red-400",hidden:t.desc.length!==0,children:"This field cant be empty"})]})}),e.jsx(p,{title:"Reward",editMode:n,type:"text",children:e.jsx(e.Fragment,{children:n?e.jsxs("div",{className:"flex items-center justify-stretch h-fit",children:[e.jsxs("div",{className:"w-2/5 h-full flex flex-col justify-between",children:[e.jsx(y,{placeholder:"Cost...",inputMode:"numeric",type:"number",status:t.reward.cost===0?"error":void 0,value:t.reward.cost||"",onChange:s=>{m({...t,reward:{...t.reward,cost:Number(s.currentTarget.value)}})}}),e.jsx(b,{className:"pl-8 text-red-400",hidden:!(t.reward.cost===0&&S),children:"This field cant be empty"})]}),e.jsx("div",{className:"w-3/5 flex flex-col h-full justify-between",children:e.jsxs(Se,{className:"h-12 items-center",children:[e.jsx(K,{onClick:()=>m({...t,reward:{...t.reward,currency:"TON"}}),mode:t.reward.currency==="TON"?"bezeled":"plain",children:"TON"}),e.jsx(K,{onClick:()=>m({...t,reward:{...t.reward,currency:"USDT"}}),mode:t.reward.currency==="USDT"?"bezeled":"plain",children:"USDT"})]})})]}):t.reward.cost+" "+t.reward.currency})}),t.attachments&&t.attachments.length>0&&e.jsx(p,{title:"Attachments",type:"other",children:e.jsx("div",{className:"pl-6 pr-6 p-2 grid grid-flow-row grid-cols-3 gap-2",children:t.attachments.map((s,c)=>e.jsxs("div",{className:"relative",children:[e.jsx(Oe,{size:96,src:s,onClick:()=>le(c)}),n&&e.jsx(ve,{className:"absolute right-0 -top-2 w-6 h-6 border border-gray-500 rounded-full bg-gray-400 bg-opacity-55",onClick:()=>se(c)})]},c+s))})}),n&&e.jsx(Le,{multiple:!0,label:"Attach a new file",accept:"image/*",onChange:te}),e.jsx(p,{title:"Customer",type:"text",children:(O=t.customer)==null?void 0:O.name}),e.jsx("div",{children:e.jsx(p,{title:"Address",editMode:n,type:"other",children:e.jsxs(e.Fragment,{children:[n?e.jsxs(e.Fragment,{children:[e.jsx(T,{multiline:!0,children:(M=(L=t.location)==null?void 0:L.address)==null?void 0:M.formattedAdress}),e.jsx(Ae,{status:!((R=t.location)!=null&&R.available)&&S?"error":void 0,geoposition:t.location||{available:!1},setGeoposition:s=>m({...t,location:s})})]}):(V=(U=t.location)==null?void 0:U.address)==null?void 0:V.formattedAdress,e.jsx(b,{className:"pl-8 text-red-400",hidden:(J=t.location)==null?void 0:J.available,children:"Please enter correct address"})]})})}),e.jsx("div",{className:"pb-8",children:e.jsx(p,{title:"On map",type:"other",children:e.jsx(Be,{available:((P=t.location)==null?void 0:P.available)||!1,type:"target",center:{latitude:Number((z=(Z=t.location)==null?void 0:Z.latLong)==null?void 0:z.latitude),longitude:Number(($=(Y=t.location)==null?void 0:Y.latLong)==null?void 0:$.longitude)}})})})]})})}),e.jsxs("div",{className:"sticky bottom-24 pl-4 pr-4",children:[!g&&e.jsxs("div",{className:"flex flex-row justify-center items-center",children:[a.status==="open"&&e.jsx(x,{className:"bg-green-600 w-2/6",onClick:ce,loading:C,children:"Accept"}),a.status==="active"&&e.jsx(x,{className:"bg-red-600 w-2/6",onClick:oe,loading:A,children:"Decline"})]}),g&&!n&&e.jsxs("div",{className:"flex flex-row justify-center items-center",children:[a.status==="open"&&e.jsx(x,{className:"bg-red-600 w-1/2",onClick:re,loading:C,children:"Delete task"}),a.status==="active"&&e.jsx(x,{className:"bg-red-600 w-1/2",disabled:!0,children:"You cant delete active task"})]}),g&&n&&e.jsxs("div",{className:"flex flex-row justify-center items-center",children:[e.jsx(x,{className:"bg-green-600 w-2/6",onClick:de,loading:C,children:"Confirm"}),e.jsx(x,{className:"bg-red-600 w-2/6",onClick:ue,loading:A,children:"Cancel"})]})]})]}),e.jsx(Ee,{open:ae,controller:{closeOnPullDown:!0,closeOnBackdropClick:!0,closeOnPullUp:!0},close:ie,index:ne,plugins:[De],slides:(G=a==null?void 0:a.attachments)==null?void 0:G.map(s=>({src:s}))})]})};export{_e as TaskCard,Qe as TaskMiniCard};
