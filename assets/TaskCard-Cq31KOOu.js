import{r as l,j as s,C,e as y,f as xe,b as pe,Y as ee,B as je,J as be,d as ve,s as we,Z as Ne,$ as Ce,a0 as ye,T as Te,a1 as Fe,a2 as _,a3 as Ie}from"./index-Dkb9DNe9.js";import{c as De}from"./calcDistance-p9X9NEyQ.js";import{C as U,B as b,S as Ae,b as Ee,L as Be}from"./Section-BjHga8C4.js";import{I as Le,a as S,L as Oe,Z as Me}from"./index-CRgsEX3j.js";import{I as Re,F as ke,G as Ue,M as Pe}from"./MapContainerYandex-CpyZbxaU.js";import{m as Ze}from"./proxy-C3KwKnZw.js";import{I as Je,F as Ye}from"./FileInput-BHWZBpIT.js";import{A as ze}from"./Avatar-mvJbxORT.js";import{I as k}from"./Input-Cfn_U49V.js";import"./VisuallyHidden-IYEy-9wn.js";function Ge({title:c,titleId:r,...o},n){return l.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true","data-slot":"icon",ref:n,"aria-labelledby":r},o),c?l.createElement("title",{id:r},c):null,l.createElement("path",{d:"M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32L19.513 8.2Z"}))}const He=l.forwardRef(Ge),v=({title:c,children:r,editMode:o=!1})=>{const[n,e]=l.useState(!1);return s.jsxs("div",{children:[s.jsx(C,{level:"2",weight:"2",className:"pl-6 text-[--tg-theme-hint-color]",children:c}),o?r:s.jsx(U,{multiline:n,onClick:()=>e(d=>!d),children:r})]})},ss=({task:c})=>{const r=y(xe),o=pe(),n=y(h=>ee(h,c.id)),[e,d]=l.useState();return l.useEffect(()=>{var h;d(De((h=c.location)==null?void 0:h.latLong,r.latLong))},[r,c]),s.jsx(s.Fragment,{children:s.jsx(U,{before:s.jsx(ze,{children:"CS"}),id:c.id,className:"w-full select-none",multiline:!1,description:c.desc,after:s.jsx("span",{children:c.reward.cost+" "+c.reward.currency}),titleBadge:n?s.jsx(je,{className:"bg-yellow-600",mode:"critical",type:"number",children:"!"}):s.jsx(s.Fragment,{}),subhead:e+" km",onClick:()=>o("/tasks/task/"+c.id),children:c.title})})},ts=()=>{var H,$,q,K,Q,V,W;const c=be(),r=ve(),o=y(we),n=c.taskId||"-1",e=y(t=>Ne(t,n)),[d,h]=l.useState((e==null?void 0:e.title)||""),[g,T]=l.useState((e==null?void 0:e.desc)||""),[f,F]=l.useState(((H=e==null?void 0:e.reward)==null?void 0:H.cost)||0),[j,w]=l.useState((($=e==null?void 0:e.reward)==null?void 0:$.currency)||"TON"),[x,N]=l.useState((e==null?void 0:e.attachments)||[]),[i,I]=l.useState((e==null?void 0:e.location)||{available:!1}),L=l.useMemo(()=>e==null?void 0:e.customer,[e]),D=l.useMemo(()=>(e==null?void 0:e.customer.id)===o.id,[e,o]),[P,se]=l.useState(!1),te=l.useCallback(()=>{var a,m;const t=JSON.parse(sessionStorage.getItem("edited-task-"+n)||"{}");try{h(t.title),T(t.desc),F(((a=t==null?void 0:t.reward)==null?void 0:a.cost)||0),w(((m=t==null?void 0:t.reward)==null?void 0:m.currency)||"TON"),N(t.attachments||[]),I(t.location)}catch{console.log("Cant parse saved task")}},[n]),O=l.useCallback(()=>{if(e)return{...e,title:d,desc:g,reward:{cost:f,currency:j},attachments:x,location:i}},[e,d,g,f,j,x,i]),[p,A]=l.useState(y(t=>ee(t,n))||!1),[u,E]=l.useState(p||!1),[le,Z]=l.useState(!1),ae=t=>{t.preventDefault(),console.log("Edit mode handler"),E(!0),p&&Z(!0),u&&!p&&E(!1)};l.useEffect(()=>{var t,a;p||(console.log("Update fields on stored task change"),h((e==null?void 0:e.title)||""),T((e==null?void 0:e.desc)||""),F(((t=e==null?void 0:e.reward)==null?void 0:t.cost)||0),w(((a=e==null?void 0:e.reward)==null?void 0:a.currency)||"TON"),N((e==null?void 0:e.attachments)||[]),I((e==null?void 0:e.location)||{available:!1}))},[e,p]),l.useEffect(()=>{p&&(console.log("Restore edited task"),te())},[]),l.useEffect(()=>{d.trim()!==(e==null?void 0:e.title)||g.trim()!==e.desc||f!==e.reward.cost||(j||"").trim()!==e.reward.currency||x!==e.attachments||i!==e.location?(console.log("Changes made"),A(!0)):(console.log("No changes"),A(!1))},[e,d,g,f,j,x,i]),l.useEffect(()=>{p?(console.log("Save edited task state"),sessionStorage.setItem("edited-task-"+n,JSON.stringify(O())),r(Ce(n))):(console.log("Remove edited task state"),sessionStorage.removeItem("edited-task-"+n),r(ye(n)))},[n,p,r,O]);const ne=t=>{t.preventDefault();const a=t.currentTarget.files;if(console.log(a),a&&(a==null?void 0:a.length)>0){const m=[];for(let R=0;R<a.length;R++)m.push(URL.createObjectURL(a[R]));const X=x||[];console.log([...X,...m]),N([...X,...m])}},ie=t=>{const a=[...x];a.splice(t,1),N(a)},[ce,J]=l.useState(!1),[re,Y]=l.useState(0),oe=t=>{console.log("Open image fullscreen. Index: "+t),J(!0),Y(t)},de=()=>{console.log("Close image fullscreen"),J(!1),Y(0)},ue=async t=>{t.preventDefault(),B(!0),setTimeout(()=>{console.log("Do something after 2 secs"),r(Fe(n)),B(!1),history.back()},2e3)},[M,B]=l.useState(!1),[z,G]=l.useState(!1),me=async t=>{e&&(t.preventDefault(),console.log("Clicked accept"),B(!0),setTimeout(()=>{console.log("Do something after 2 secs"),r(_({id:e.id,status:"active",user:{id:o.id,name:(o.firstName+" "+o.lastName||"").trim()}})),B(!1),history.back()},2e3))},he=async t=>{e&&(t.preventDefault(),console.log("Clicked dismiss"),G(!0),await setTimeout(()=>{console.log("Do something after 5 secs"),r(_({id:e.id,status:"open",user:{id:o.id,name:(o.firstName+" "+o.lastName||"").trim()}})),G(!1),history.back()},2e3))},ge=()=>{const t=document.getElementsByTagName("input");for(let m=0;m<t.length;m++)t[m].blur();if(d.trim().length===0||g.trim().length===0||f===0||!i.available)return se(!0);const a=O();a&&(console.log("Save edited task to Redux"),r(Ie(a)),A(!1),E(!1))},fe=()=>{var t,a;A(!1),E(!1),h((e==null?void 0:e.title)||""),T((e==null?void 0:e.desc)||""),F(((t=e==null?void 0:e.reward)==null?void 0:t.cost)||0),w(((a=e==null?void 0:e.reward)==null?void 0:a.currency)||"TON"),N((e==null?void 0:e.attachments)||[]),I((e==null?void 0:e.location)||{available:!1})};return e?s.jsx(Ze.div,{initial:{opacity:0,y:200},animate:{opacity:1,y:0},exit:{opacity:0,y:200},children:s.jsxs("div",{className:"flex flex-col gap-1 h-full",children:[s.jsxs("div",{className:"p-2 flex align-middle items-center justify-between w-full",children:[s.jsx(Te,{children:"Task details"}),s.jsx(b,{mode:"plain",onClick:()=>history.back(),children:"Back"})]}),s.jsxs(Ae,{header:s.jsxs("div",{className:"flex justify-between align-middle p-2",children:[s.jsxs(Ee,{children:["Task N",n]}),D&&s.jsx(Re,{className:"w-8 h-8 self-end".concat(" ",le?"animate-jiggle text-red-400":""),onClick:ae,onAnimationEnd:()=>{Z(!1)},children:s.jsx(He,{})})]}),children:[p&&s.jsx("div",{className:"bg-yellow-400 text-center rounded-lg mb-1",children:"You have uncommited changes!!!"}),s.jsxs(Be,{className:"flex flex-col gap-2 h-full",children:[s.jsx(v,{title:"Title",editMode:u,children:s.jsxs(s.Fragment,{children:[u?s.jsx(k,{value:d,status:d.length===0?"error":"default",placeholder:"Title...",onChange:t=>{const a=t.currentTarget.value;h(a)}}):d,s.jsx(C,{className:"pl-8 text-red-400",hidden:d.length!==0,children:"This field cant be empty"})]})}),s.jsx(v,{title:"Description",editMode:u,children:s.jsxs(s.Fragment,{children:[u?s.jsx(k,{placeholder:"Description...",value:g,status:g.length===0?"error":"default",onChange:t=>T(t.currentTarget.value)}):g,s.jsx(C,{className:"pl-8 text-red-400",hidden:g.length!==0,children:"This field cant be empty"})]})}),s.jsx(v,{title:"Reward",editMode:u,children:s.jsx(s.Fragment,{children:u?s.jsxs("div",{className:"flex items-center justify-stretch h-fit",children:[s.jsxs("div",{className:"w-2/5 h-full flex flex-col justify-between",children:[s.jsx(k,{placeholder:"Cost...",inputMode:"numeric",type:"number",status:f===0?"error":"default",value:f||"",onChange:t=>{F(Number(t.currentTarget.value))}}),s.jsx(C,{className:"pl-8 text-red-400",hidden:!(f===0&&P),children:"This field cant be empty"})]}),s.jsx("div",{className:"w-3/5 flex flex-col h-full justify-between",children:s.jsxs(Le,{className:"h-12 items-center",children:[s.jsx(S,{onClick:()=>w("TON"),mode:j==="TON"?"bezeled":"plain",children:"TON"}),s.jsx(S,{onClick:()=>w("USDT"),mode:j==="USDT"?"bezeled":"plain",children:"USDT"})]})})]}):f+" "+j})}),x&&x.length>0&&s.jsx(v,{title:"Attachments",children:s.jsx("div",{className:"pl-6 pr-6 p-2 grid grid-flow-row grid-cols-3 gap-2",children:x.map((t,a)=>s.jsxs("div",{className:"relative",children:[s.jsx(Je,{size:96,src:t,onClick:()=>oe(a)}),u&&s.jsx(ke,{className:"absolute right-0 -top-2 w-6 h-6 border border-gray-500 rounded-full bg-gray-400 bg-opacity-55",onClick:()=>ie(a)})]},a+t))})}),u&&s.jsx(Ye,{multiple:!0,label:"Attach a new file",accept:"image/*",onChange:ne}),s.jsx(v,{title:"Customer",children:L==null?void 0:L.name}),s.jsx("div",{children:s.jsx(v,{title:"Address",editMode:u,children:s.jsxs(s.Fragment,{children:[u?s.jsxs(s.Fragment,{children:[s.jsx(U,{multiline:!0,children:(q=i==null?void 0:i.address)==null?void 0:q.formattedAdress}),s.jsx(Ue,{status:!i.available&&P?"error":"default",geoposition:i||{available:!1},setGeoposition:t=>I(t)})]}):(K=i==null?void 0:i.address)==null?void 0:K.formattedAdress,s.jsx(C,{className:"pl-8 text-red-400",hidden:i.available,children:"Please enter correct address"})]})})}),s.jsx("div",{className:"pb-8",children:s.jsx(v,{title:"On map",children:s.jsx(Pe,{available:i.available,type:"target",center:{latitude:Number((Q=i.latLong)==null?void 0:Q.latitude),longitude:Number((V=i.latLong)==null?void 0:V.longitude)}})})})]}),s.jsxs("div",{className:"sticky bottom-24 w-full flex justify-around p-4",children:[!D&&s.jsxs(s.Fragment,{children:[e.status==="open"&&s.jsx(b,{className:"bg-green-600 w-2/6",onClick:me,loading:M,children:"Accept"}),e.status==="active"&&s.jsx(b,{className:"bg-red-600 w-2/6",onClick:he,loading:z,children:"Decline"})]}),D&&!u&&s.jsxs(s.Fragment,{children:[e.status==="open"&&s.jsx(b,{className:"bg-red-600 w-1/2",onClick:ue,loading:M,children:"Delete task"}),e.status==="active"&&s.jsx(b,{className:"bg-red-600 w-1/2",disabled:!0,children:"You cant delete active task"})]}),D&&u&&s.jsxs(s.Fragment,{children:[s.jsx(b,{className:"bg-green-600 w-2/6",onClick:ge,loading:M,children:"Confirm"}),s.jsx(b,{className:"bg-red-600 w-2/6",onClick:fe,loading:z,children:"Cancel"})]})]}),s.jsx(Oe,{open:ce,controller:{closeOnPullDown:!0,closeOnBackdropClick:!0,closeOnPullUp:!0},close:de,index:re,plugins:[Me],slides:(W=e==null?void 0:e.attachments)==null?void 0:W.map(t=>({src:t}))})]})]})}):s.jsx(s.Fragment,{children:"Task not found"})};export{ts as TaskCard,ss as TaskMiniCard};
